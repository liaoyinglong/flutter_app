name: Flutter Linux Build and Snap

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: '3.24.0'
        channel: 'stable'
    
    - name: Install Linux dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y clang cmake ninja-build pkg-config libgtk-3-dev liblzma-dev
    
    - name: Install Flutter dependencies
      run: flutter pub get
    
    - name: Enable Linux desktop
      run: flutter config --enable-linux-desktop
    
    - name: Build Linux
      run: flutter build linux --release
    
    - name: Install Snapcraft
      run: |
        sudo snap install snapcraft --classic
        sudo chown root:root /
    - name: Create snapcraft.yaml
      run: |
        mkdir -p snap
        cat << EOF > snap/snapcraft.yaml
        name: f_demo
        version: '1.0.0'
        summary: Short summary of your app
        description: |
          A longer description of your app.

        confinement: strict
        base: core22
        grade: stable

        apps:
          f_demo:
            command: bin/f_demo
            plugs:
              - network
              - desktop
              - desktop-legacy
              - wayland
              - x11

        parts:
          f_demo:
            plugin: nil
            source: build/linux/x64/release/bundle
            override-build: |
              craftctl default
              mkdir -p $CRAFT_PART_INSTALL/bin
              cp -r $CRAFT_PART_SRC/* $CRAFT_PART_INSTALL/bin/
            stage-packages:
              - libgtk-3-0
              - libblkid1
              - liblzma5
        
        layout:
          /usr/lib/$CRAFT_ARCH_TRIPLET/webkit2gtk-4.0:
            bind: $SNAP/usr/lib/$CRAFT_ARCH_TRIPLET/webkit2gtk-4.0
        EOF
    
    - name: Build Snap
      run: snapcraft --destructive-mode
    
    - name: Archive Snap
      uses: actions/upload-artifact@v3
      with:
        name: snap-package
        path: '*.snap'